trigger:
  branches:
    include:
      - main

pool:
  name: Default   # Your self-hosted agent pool

variables:
  imageName: webwander
  tag: latest
  dockerRegistry: ''

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildDockerImage
    displayName: Build Docker Image
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - checkout: self
      clean: true

    - script: |
        echo "Installing dependencies"
        cd frontend
        npm install
      displayName: 'Install npm dependencies'

    - script: |
        echo "Building Docker image"
        cd frontend
        # Build with temporary override of TS module option
        docker build \
          --build-arg TS_MODULE=Node16 \
          -t $(imageName):$(tag) .
      displayName: 'Build Docker image'

- stage: Deploy
  displayName: Deploy Stage
  dependsOn: Build
  jobs:
  - job: RunContainer
    displayName: Deploy Docker Container
    steps:
    - script: |
        echo "Stopping existing container (if any)"
        docker stop $(imageName) || true
        docker rm $(imageName) || true
      displayName: 'Stop old container'

    - script: |
        echo "Running Docker container"
        docker run -d -p 80:80 --name $(imageName) $(imageName):$(tag)
      displayName: 'Run Docker container'
