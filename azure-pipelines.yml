trigger:
  branches:
    include:
      - main

pool:
  name: Default  # your self-hosted agent
  # vmImage: 'ubuntu-latest' if using Microsoft-hosted agent

variables:
  imageName: webwander
  tag: latest

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildDockerImage
    displayName: Build Docker Image
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - checkout: self
      clean: true

    - script: |
        echo "Building Docker image"
        docker build -t $(imageName):$(tag) .
      displayName: 'Build Docker image'

    # Optional push to registry
    # - script: |
    #     docker login -u <username> -p <password> docker.io
    #     docker tag $(imageName):$(tag) <username>/$(imageName):$(tag)
    #     docker push <username>/$(imageName):$(tag)
    #   displayName: 'Push Docker image'

- stage: Deploy
  displayName: Deploy Stage
  dependsOn: Build
  jobs:
  - job: RunContainer
    displayName: Deploy Docker Container
    steps:
    - script: |
        echo "Stopping existing container (if any)"
        docker stop $(imageName) || true
        docker rm $(imageName) || true
      displayName: 'Stop old container'

    - script: |
        echo "Running Docker container"
        docker run -d -p 80:80 --name $(imageName) $(imageName):$(tag)
      displayName: 'Run Docker container'
